<!DOCTYPE HTML>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        canvas {
            display: block;
            margin: 0 auto;
            background-color: lightgreen;
            border-radius: 15px;
        }
    </style>
    <title>疑似スプラトゥーン</title>
</head>

<body>
    <div hidden>
        <audio src="shot.wav" id="shot"></audio>
        <audio src="hit.wav" id="hit"></audio>
        <audio src="death.wav" id="death"></audio>
        <audio src="kill.mp3" id="kill"></audio>
        <audio src="opening.mp3" id="opening"></audio>
        <audio src="" id="bgm"></audio>
        <audio src="bgm/Now or Never!.mp3" id="NowOrNever"></audio>
        <img src="title.png" alt="タイトル" id="title">
    </div>
    <canvas>お使いのブラウザでは、HTML5に対応していません</canvas>
    <noscript>お使いのブラウザのjavascriptをオンにしてください</noscript>
    <span style="display: block;text-align: center;">
        クリックでスタート
        WASDキーで操作
        マウスで射撃
    </span>
    <script>
        document.querySelector("audio#bgm").src = `bgm/${Math.round(Math.random() * 3) + 1}.mp3`
        const canvas = document.querySelector('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 800;
        canvas.height = 600;
        const keys = [];
        const logs = [];
        let kill = 0;
        let death = 0;
        let player_number = "player1";
        let camera_x = -400;
        let camera_y = 0;
        let mouse_x = 0;
        let mouse_y = 0;
        let mouse_pressed = false;
        let timer = 180;
        let state = "opening";
        let opening_frame = 0;
        let finish_frame = 0;
        let yellow = 0;
        let blue = 0;
        const player_data = {
            player1: {
                x: -1000,
                y: 0,
                color: "yellow",
                falling_speed: 0,
                grounded: true,
                bullet_frame: 0,
                isSquid: false,
                onInk: false,
                isCPU: false,
                xDir: 0,
                yDir: 5,
                damage: 0,
                name: "Player1",
                lastdamaged: "",
                death: false,
                CPU_task: [],
            },
            player2: {
                x: 1000,
                y: 0,
                color: "blue",
                falling_speed: 0,
                grounded: true,
                bullet_frame: 0,
                isSquid: false,
                onInk: false,
                isCPU: true,
                xDir: 0,
                yDir: 5,
                damage: 0,
                name: "CPU",
                lastdamaged: "",
                death: false,
                CPU_task: [],
            }
        };
        const ground_data = [
            { position: [-1100, 500, 1100, 550], color: "brown" },
            { position: [-930, 400, -700, 500], color: "gray" },
            { position: [-650, 320, -600, 380], color: "gray" },
            { position: [-650, 280, -300, 320], color: "gray" },
            { position: [-280, 200, -100, 250], color: "gray" },
            { position: [-200, 450, 200, 500], color: "gray" },
            { position: [-50, 100, 50, 410], color: "gray" },
            { position: [700, 400, 930, 500], color: "gray" },
            { position: [600, 320, 650, 380], color: "gray" },
            { position: [300, 280, 650, 320], color: "gray" },
            { position: [100, 200, 280, 250], color: "gray" },
        ];
        const painted_data = [];
        const bullet_data = [];
        document.addEventListener("keydown", (e) => {
            if (!keys.includes(e.key)) {
                keys.push(e.key);
            }
            if (e.key == "e") {
                player_data[player_number].isSquid = !player_data[player_number].isSquid; // イカ状態の切り替え
            }
        });
        document.addEventListener("keyup", (e) => {
            const index = keys.indexOf(e.key);
            if (index > -1) {
                keys.splice(index, 1);
            }
        });
        document.addEventListener("mousemove", (e) => {
            mouse_x = e.clientX - canvas.getBoundingClientRect().left;
            mouse_y = e.clientY - canvas.getBoundingClientRect().top;
        });
        document.addEventListener("mousedown", () => {
            mouse_pressed = true;
        });
        document.addEventListener("mouseup", () => {
            mouse_pressed = false;
        });
        function getAngle(x1, y1, x2, y2, degree = true) {
            const dx = x2 - x1;
            const dy = y2 - y1;
            let theta = Math.atan2(dy, dx); // ラジアン

            return degree ? theta * 180 / Math.PI : theta;
        }
        function add_bullet_data(player, type = 1) {
            let bullet;
            if (type == 1) {
                bullet = {
                    whose: player.name,
                    x: player.x,
                    y: player.y - 10,
                    color: player.color,
                    falling_speed: 0,
                    frame: 0,
                    attack: 28,
                    direction: getAngle(player.x, player.y, mouse_x + camera_x, mouse_y + camera_y, false),
                };
            } else if (type == 2) {
                bullet = player;
            } else if (type == 3) {
                bullet = {
                    whose: player.name,
                    x: player.x,
                    y: player.y - 10,
                    color: player.color,
                    falling_speed: 0,
                    frame: 0,
                    attack: 28,
                    direction: getAngle(player.x, player.y, player.x + player.xDir, player.y - player.yDir, false),
                };
            }
            bullet_data.push(bullet);
        }
        function drawGround() {
            ground_data.forEach(ground => {
                ctx.fillStyle = ground.color;
                ctx.fillRect(ground.position[0] - camera_x, (ground.position[1] - camera_y), ground.position[2] - ground.position[0], ground.position[3] - ground.position[1]);
            });
        }
        function drawPlayer() {
            for (const playerKey in player_data) {
                const player = player_data[playerKey];
                if (player.death) { continue }
                if (player.isSquid && player.onInk) {
                    // 最終消す部分
                    // ctx.fillStyle = player.color;
                    // ctx.fillRect(player.x - camera_x - 10, (player.y - camera_y) - 3, 20, 3);
                    // ctx.strokeRect(player.x - camera_x - 10, (player.y - camera_y) - 3, 20, 3);

                } else if (!player.onInk && player.isSquid) {
                    ctx.fillStyle = player.color;
                    ctx.fillRect(player.x - camera_x - 10, (player.y - camera_y) - 3, 20, 3);
                    ctx.strokeRect(player.x - camera_x - 10, (player.y - camera_y) - 3, 20, 3);
                } else {
                    ctx.fillStyle = player.color;
                    ctx.fillRect(player.x - camera_x - 10, (player.y - camera_y) - 20, 20, 20);
                    ctx.strokeRect(player.x - camera_x - 10, (player.y - camera_y) - 20, 20, 20);
                }
            }
        }
        function drawBullet() {
            bullet_data.forEach(bullet => {
                bullet.x += Math.cos(bullet.direction) * 10; // 弾の移動
                bullet.y += Math.sin(bullet.direction) * 10; // 弾の移動
                bullet.y += bullet.falling_speed; // 弾の落下
                if (bullet.frame > 10) {
                    bullet.falling_speed += 1
                }
                bullet.frame += 1; // 弾のフレーム
                if (bullet.frame > 60) {
                    bullet_data.splice(bullet_data.indexOf(bullet), 1);
                    return;
                }
                // 飛沫
                if (Math.random() < 0.6 && bullet.attack != 0) {
                    add_bullet_data({
                        x: bullet.x,
                        y: bullet.y,
                        color: bullet.color,
                        falling_speed: 0,
                        frame: 0,
                        attack: 0,
                        direction: Math.PI / 2
                    }, 2);
                }
                // 地面との衝突判定
                for (const ground of ground_data) {
                    if (bullet.x > ground.position[0] && bullet.x < ground.position[2] && bullet.y >= ground.position[1] && bullet.y <= ground.position[3]) {
                        bullet_data.splice(bullet_data.indexOf(bullet), 1);
                        // 塗る位置を計算
                        if (Math.abs(bullet.y - ground.position[1]) < 5) {
                            var paintX = bullet.x;
                            var paintY = ground.position[1];
                        } else {
                            var paintY = bullet.y;
                            if (Math.abs(bullet.x - ground.position[0] < Math.abs(bullet.x - ground.position[2]))) {
                                var paintX = ground.position[0];
                            } else {
                                var paintX = ground.position[2];
                            }
                        }
                        // 塗る
                        painted_data.push({
                            x: paintX,
                            y: paintY,
                            color: bullet.color
                        });
                        return;
                    }
                }
                if (bullet.attack != 0) {
                    // プレイヤーとの衝突判定
                    for (const playerKey in player_data) {
                        const player = player_data[playerKey];
                        if (!player.death && Math.abs(bullet.x - player.x) < 10 && Math.abs(bullet.y - player.y) < 20 && bullet.color != player.color) {
                            bullet_data.splice(bullet_data.indexOf(bullet), 1);
                            player.damage += bullet.attack;
                            player.lastdamaged = bullet.whose;
                            addPulse(bullet.x - camera_x, bullet.y - camera_y)
                            // ノックバック
                            if (bullet.x < player.x) {
                                player.x += bullet.attack / 2;
                            } else {
                                player.x -= bullet.attack / 2;
                            }
                            // 音を再生
                            document.getElementById("hit").currentTime = 0; // 音をリセット
                            document.getElementById("hit").play();
                            return;
                        }
                    }
                    // 描画
                    ctx.beginPath();
                    ctx.fillStyle = bullet.color;
                    ctx.arc(bullet.x - camera_x, bullet.y - camera_y, 5, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
        }
        function drawPainted() {
            painted_data.forEach(paint => {
                // 10の倍数に直す
                paint.x = Math.round(paint.x / 10) * 10;
                paint.y = Math.round(paint.y / 10) * 10;
                // 重複したら古いデータを消す
                for (let i = 0; i < painted_data.length; i++) {
                    if (painted_data[i].x === paint.x && painted_data[i].y === paint.y && painted_data[i] !== paint) {
                        painted_data.splice(i, 1);
                        i--; // 削除したのでインデックスを戻す
                    }
                }
                ctx.fillStyle = paint.color;
                ctx.fillRect(paint.x - camera_x, paint.y - camera_y, 11, 11);
            });
        }
        function count_color() {
            blue = 0; yellow = 0
            for (var i of painted_data) {
                if (i.color == "yellow") {
                    yellow++
                }
                if (i.color == "blue") {
                    blue++
                }
            }
        }
        function update(now) {
            if (state == "opening") {
                if (opening_frame == 0) {
                    if (mouse_pressed) {
                        opening_frame = 1;
                        document.getElementById("opening").play();
                    }
                } else {
                    opening_frame += 1;
                }
            } else if (state == "playing") {
                // プレイヤー制御
                for (var i in player_data) {
                    player = player_data[i];
                    if (player.death) { continue }
                    // 落下計算
                    if (!player.grounded) {
                        player.falling_speed += 0.25; // 重力
                        player.y += player.falling_speed;
                    } else {
                        player.falling_speed = 0;
                    }
                    // 死亡判定
                    if (player.y > 600) {
                        player.death = true;
                        const currentPlayer = player; // Capture the current player
                        document.getElementById("death").currentTime = 0; // 音をリセット
                        document.getElementById("death").play();
                        setTimeout(() => {
                            currentPlayer.damage = 0;
                            currentPlayer.y = 0;
                            currentPlayer.x = (currentPlayer.color == "yellow") ? -1000 : 1000;
                            currentPlayer.falling_speed = 0;
                            currentPlayer.death = false;
                            currentPlayer.CPU_task = [];
                        }, 3000); // 1秒後に復活
                    }
                    if (player.damage > 100) {
                        if (player.color == "yellow") {
                            death++
                            document.getElementById("death").currentTime = 0; // 音をリセット
                            document.getElementById("death").play();
                        } else {
                            kill++
                            document.getElementById("kill").currentTime = 0; // 音をリセット
                            document.getElementById("kill").play();

                        }
                        console.log(`キル数: ${kill} デス数: ${death}`)
                        player.death = true;
                        const currentPlayer = player; // Capture the current player
                        setTimeout(() => {
                            currentPlayer.damage = 0;
                            currentPlayer.y = 0;
                            currentPlayer.x = (currentPlayer.color == "yellow") ? -1000 : 1000;
                            currentPlayer.falling_speed = 0;
                            currentPlayer.death = false;
                            currentPlayer.CPU_task = [];
                        }, 3000); // 1秒後に復活
                        if (player.lastdamaged == player_data[player_number].name) {
                            logs.push({ name: player.name, frame: 300 });
                        }
                    }
                    // ダメージ減衰
                    if (player.damage > 0) {
                        player.damage -= (player.isSquid && player.onInk) ? 1 : 0.1;
                        if (player.damage < 0) {
                            player.damage = 0;
                        }
                    }
                    // 地面との衝突判定
                    player.grounded = false;
                    for (const ground of ground_data) {
                        if (player.x > ground.position[0] && player.x < ground.position[2] && player.y >= ground.position[1] && player.y + 20 <= ground.position[3]) {
                            player.grounded = true;
                            player.y = ground.position[1] - 1;
                            player.falling_speed = 0;
                        }
                    }
                    // プレイヤー制御
                    if (player_number == i) {
                        let speed = mouse_pressed ? 0.5 : 1.5;
                        if (player.isSquid && player.onInk) {
                            speed = 4;
                        }
                        if (player.isSquid && player.falling_speed < 0) {
                            speed = 3;
                        }
                        if (keys.includes("a")) {
                            player.x -= speed;
                        }
                        if (keys.includes("d")) {
                            player.x += speed;
                        }
                        // ジャンプ
                        if ((keys.includes("w") || keys.includes(" ")) && player.grounded) {
                            player.falling_speed = -6; // ジャンプ力
                            player.grounded = false;
                        }
                        // 弾を撃つ
                        if (mouse_pressed && player.bullet_frame <= 0) {
                            player.isSquid = false;
                            add_bullet_data(player);
                            player.bullet_frame = 4; // 弾を撃つまでのフレーム
                            // 音を再生
                            document.getElementById("shot").currentTime = 0; // 音をリセット
                            document.getElementById("shot").play();
                        } else {
                            player.bullet_frame -= 1;
                        }
                        // イカ状態
                        if (player.isSquid && player.onInk && keys.length == 0) {
                            if (document.querySelector("audio#bgm").volume > 0.1) {
                                document.querySelector("audio#bgm").volume -= 0.01
                                document.querySelector("audio#NowOrNever").volume -= 0.01
                            }
                        } else {
                            document.querySelector("audio#bgm").volume = 0.5
                            document.querySelector("audio#NowOrNever").volume = 0.5
                        }
                    }
                    // CPU制御
                    if (player.isCPU) {
                        // ジャンプ
                        if (player_data.player1.y > 300) {
                            if (player.x > 740 && player.x < 750 && player.grounded) {
                                player.falling_speed = -6;
                                player.grounded = false;
                            }
                        }
                        // CPUの移動
                        let speed = mouse_pressed ? 0.5 : 1.5;
                        if (player.isSquid && player.onInk) {
                            speed = 4;
                        }
                        if (player.isSquid && player.falling_speed < 0) {
                            speed = 3;
                        }
                        shot = false;
                        if (!player_data[player_number].isSquid && Math.sqrt((player.x - player_data[player_number].x) ** 2 + (player.y - player_data[player_number].y) ** 2) < 250 && Math.abs(player.y - player_data[player_number].y) < 50 && player.CPU_task[0] != "たたかう") {
                            if (!player_data[player_number].death) {
                                player.CPU_task.unshift("たたかう")
                            }
                        } else if ((player_data[player_number].death || Math.sqrt((player.x - player_data[player_number].x) ** 2 + (player.y - player_data[player_number].y) ** 2) > 300 || Math.abs(player.y - player_data[player_number].y > 50)) && player.CPU_task[0] == "たたかう") {
                            player.CPU_task.splice(0, 1)
                            if (player.CPU_task[0] == "潜伏") {
                                player.CPU_task.splice(0, 1)
                            }
                        }
                        if (player.CPU_task.length == 0) {
                            if (Math.random() > 0.9) {
                                player.CPU_task.push("潜伏")
                            } else {
                                player.CPU_task.push("中央へ向かう")
                                if (Math.random() > 0.5) {
                                    player.CPU_task.push("ジャンプ")
                                    player.CPU_task.push("壁を上る")
                                }
                                if (Math.random() > 0.7) {
                                    player.CPU_task.push("敵陣を塗る")
                                } else if (Math.random() > 0.7) {
                                    player.CPU_task.push("敵高台へ潜伏")
                                } else {
                                    if (player_data.player1.x > 0 && Math.random() > 0.4) {
                                        player.CPU_task.push("自陣を塗る")
                                    } else {
                                        player.CPU_task.push("敵高台へ潜伏")
                                    }
                                }
                            }
                        }
                        if (player.CPU_task[0] == "中央へ向かう") {
                            if (player.x > 50) {
                                player.x -= speed;
                                player.xDir = -10
                                player.yDir = 2 + Math.random()
                            } else if (player.x < -50) {
                                player.x += speed;
                                player.xDir = 10
                                player.yDir = 2 + Math.random()
                            } else {
                                player.CPU_task.splice(0, 1);
                            }
                            if (player.onInk || (player.x > 680 && player.x < 740)) {
                                player.isSquid = true;
                            } else {
                                shot = true
                            }
                        }
                        if (player.CPU_task[0] == "ジャンプ" && player.grounded) {
                            player.falling_speed = -6;
                            player.grounded = false;
                            player.CPU_task.splice(0, 1)
                        }
                        if (player.CPU_task[0] == "潜伏") {
                            if (!player.onInk) {
                                player.CPU_task.splice(0, 1)
                            }
                            player.isSquid = true;
                            if (Math.abs(player_data.player1.x - player_data.player2.x) > 1000) {
                                player.CPU_task.splice(0, 1)
                            }
                        }
                        if (player.CPU_task[0] == "壁を上る") {
                            if (player.y > 430 && player.grounded) {
                                player.falling_speed = -6;
                                player.grounded = false;
                                player.CPU_task.splice(0, 1)
                            }
                            if (player.onInk) {
                                player.isSquid = true;
                            } else {
                                shot = true
                            }
                            if (player.y < 100) {
                                player.CPU_task.splice(0, 1);
                            }
                            if (player.x > 0) {
                                player.x -= speed;
                                player.xDir = -10
                                player.yDir = Math.random() * 15
                            } else {
                                player.x += speed;
                                player.xDir = 10
                                player.yDir = Math.random() * 15
                            }
                        }
                        if (player.CPU_task[0] == "敵高台へ潜伏") {
                            player.x -= speed;
                            if (player.x > -200) {
                                player.xDir = -10
                                player.yDir = 2 + Math.random()
                            }
                            if (player.onInk && player.x < -500) {
                                player.CPU_task.splice(0, 1);
                            }
                            if (player.onInk) {
                                player.isSquid = true;
                            } else {
                                shot = true
                            }
                        }
                        if (player.CPU_task[0] == "自陣を塗る") {
                            if (player.x < 500) {
                                player.x += speed;
                                player.xDir = 10
                                player.yDir = 2 + Math.random()
                            } else {
                                player.CPU_task.splice(0, 1);
                            }
                            if (player.onInk) {
                                player.isSquid = true;
                            } else {
                                shot = true
                            }
                        }
                        if (player.CPU_task[0] == "敵陣を塗る") {
                            if (player.x > -830) {
                                player.x -= speed;
                                player.xDir = -10
                                player.yDir = 2 + Math.random()
                            } else {
                                player.CPU_task.splice(0, 1);
                            }
                            if (player.onInk) {
                                player.isSquid = true;
                            } else {
                                shot = true
                            }
                        }
                        if (player.CPU_task[0] == "たたかう") {
                            player.xDir = player_data[player_number].x - player.x
                            player.yDir = (player.y - player_data[player_number].y) * 0.8;
                            if (Math.abs(player_data['player1'].x - player_data['player2'].x) > 200) {
                                player.yDir = player.y - player_data[player_number].y + 80;
                            }
                            shot = true;

                            if (Math.abs(player.x) > 120) {
                                if (player.grounded) {
                                    player.falling_speed = -6;
                                    player.grounded = false;
                                }
                            }
                            if (player.x > player_data[player_number].x + 10) {
                                player.x -= speed;
                            } else if (player.x < player_data[player_number].x - 10) {
                                player.x += speed;
                            }
                        }
                        // 弾を撃つ
                        if (player.bullet_frame <= 0 && shot) {
                            player.isSquid = false;
                            add_bullet_data(player, 3);
                            player.bullet_frame = 4; // 弾を撃つまでのフレーム
                            // 音を再生
                            // document.getElementById("shot").currentTime = 0; // 音をリセット
                            // document.getElementById("shot").play();
                        } else {
                            player.bullet_frame -= 1;
                        }
                    }
                    // 壁との衝突判定
                    for (const ground of ground_data) {
                        let pos = ground.position;
                        if (player.x + 10 >= pos[0] && player.x - 10 <= pos[2] && player.y >= pos[1] && player.y <= pos[3]) {
                            if (Math.abs(player.x - pos[0]) < Math.abs(player.x - pos[2])) {
                                player.x = pos[0] - 10;
                            } else {
                                player.x = pos[2] + 10;
                            }
                            if (player.isSquid && player.onInk) {
                                if ((player_number == i && (keys.includes("d") || keys.includes("a"))) || player.isCPU) {
                                    player.y -= 4;
                                    player.falling_speed = -4;
                                    player.grounded = true; // 地面にいる状態にする
                                }
                            }
                        }
                    }
                    // プレイヤーがインク上にいるかどうか
                    player.onInk = false;
                    for (const paint of painted_data) {
                        if (Math.abs(player.x - paint.x) < 11 && Math.abs(player.y - paint.y) < 11 && player.color == paint.color) {
                            player.onInk = true;
                            break;
                        }
                    }
                }
                // 描画制御
                if (Math.abs(player_data.player1.x - player_data.player2.x) < 300 && player_data.player2.CPU_task[0] != "潜伏") {
                    camera_x += (player_data.player1.x + player_data.player2.x) / 2 - canvas.width / 2 + 10;
                } else {
                    camera_x += player_data[player_number].x - canvas.width / 2 + 10;
                }
                camera_x /= 2;
            }
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawGround();
            drawPlayer();
            drawBullet();
            drawPainted();
            if (state == "opening") {
                // タイトル
                ctx.drawImage(document.getElementById("title"), 277 - 400 - camera_x, 190 - camera_y, 246, 210)
                ctx.textAlign = "center";
                ctx.font = "20px UDDigiKyokashoN-R";
                ctx.fillStyle = "black";
                ctx.fillText("たくさんナワバリを確保せよ!", - camera_x, 430 - camera_y)
                // 黒
                if (opening_frame < 40) {
                    ctx.fillStyle = "black";
                    ctx.fillRect(0, 0 + opening_frame * 15, canvas.width, canvas.height);
                }
                if (opening_frame > 300 && opening_frame < 700) {
                    if (opening_frame > 300 && opening_frame < 500) {
                        var player = player_data.player1;
                        camera_x += player_data.player1.x - canvas.width / 2 + 10;
                        camera_x /= 2;
                    }
                    if (opening_frame >= 500 && opening_frame < 700) {
                        var player = player_data.player2;
                        camera_x += player_data.player2.x - canvas.width / 2 + 10;
                        camera_x /= 2;
                    }
                    // 落下計算
                    if (!player.grounded) {
                        player.falling_speed += 0.25; // 重力
                        player.y += player.falling_speed;
                    } else {
                        player.falling_speed = 0;
                    }
                    player.grounded = false;
                    for (const ground of ground_data) {
                        if (player.x > ground.position[0] && player.x < ground.position[2] && player.y >= ground.position[1] && player.y + 20 <= ground.position[3]) {
                            player.grounded = true;
                            player.y = ground.position[1] - 1;
                            player.falling_speed = 0;
                        }
                    }
                }
                if (opening_frame > 700) {
                    camera_x += player_data.player1.x - canvas.width / 2 + 10;
                    camera_x /= 2;
                    ctx.font = "60px UDDigiKyokashoN-R";
                    ctx.fillStyle = "white"
                    ctx.fillText("Ready?", 400, 300)
                }
                if (opening_frame > 900) {
                    document.querySelector("audio#bgm").play()
                    state = "playing";
                }
            } else if (state == "playing") {
                // ダメージを表示 ダメージを受けていたら画面を相手の色に 不透明度=damage/2
                if (player_data[player_number].damage > 0) {
                    ctx.fillStyle = player_number == "player1" ? "rgba(0,0,255," + player_data[player_number].damage / 200 + ")" : "rgba(255,255,0," + player_data[player_number].damage / 200 + ")";
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
                // ログを表示 ログのフレームが0になったら消す
                logs.forEach(log => {
                    ctx.fillStyle = "black";
                    w = 250
                    ctx.fillRect(400 - w / 2, 535, w, 30);
                    ctx.fillStyle = "white";
                    ctx.font = "15px UDDigiKyokashoN-R";
                    ctx.textAlign = "center";
                    ctx.fillText(log.name + "をたおした!", 400, 555);
                    log.frame -= 1;
                    if (log.frame <= 0) {
                        logs.splice(logs.indexOf(log), 1);
                    }
                });
                // タイマーを表示
                timer -= 1 / 60;
                ctx.fillStyle = "black";
                w = 100
                ctx.fillRect(400 - w / 2, 10, w, 30);
                ctx.fillStyle = "white";
                ctx.font = "20px UDDigiKyokashoN-R";
                ctx.textAlign = "center";
                const minutes = Math.floor(timer / 60);
                const seconds = Math.floor(timer % 60);
                ctx.fillText(minutes + ":" + (seconds < 10 ? "0" : "") + seconds, 400, 32);

                if (timer > 178) {
                    ctx.font = "60px UDDigiKyokashoN-R";
                    ctx.fillStyle = "white"
                    ctx.fillText("Go!", 400, 300)
                }
                if (timer > 59 && timer < 61) {
                    document.getElementById("NowOrNever").play()
                    document.getElementById("bgm").pause()
                }
                if (timer < 1) {
                    state = "finish"
                }
                count_color()
            } else if (state == "finish") {
                finish_frame++
                ctx.font = "60px UDDigiKyokashoN-R";
                ctx.fillStyle = "white";
                ctx.fillText("Finish!", 400, 300);
                if (finish_frame > 200) {
                    ctx.fillStyle = "black";
                    ctx.fillRect(0, 0, canvas.width, (finish_frame - 200) * 20);
                } if (finish_frame > 230) {
                    state = "result"
                }
            } else if (state == "result") {
                finish_frame++
                ctx.fillStyle = "rgb(179, 225, 179)";
                ctx.fillRect(0, 0, canvas.width, canvas.height)
                ground_data.forEach((e) => {
                    ctx.fillStyle = e.color
                    ctx.fillRect(e.position[0] / 3 + 400, e.position[1] / 3 + 200, e.position[2] / 3 - e.position[0] / 3, e.position[3] / 3 - e.position[1] / 3)
                })
                painted_data.forEach((e) => {
                    ctx.fillStyle = e.color
                    ctx.fillRect(e.x / 3 + 400, e.y / 3 + 200, 10 / 3, 10 / 3)
                })
                if (finish_frame > 300 && finish_frame < 360) {
                    ctx.fillStyle = "yellow"
                    ctx.fillRect(50, 530, (finish_frame - 300) * 3, 50)
                    ctx.fillStyle = "blue"
                    ctx.fillRect(750 - (finish_frame - 300) * 3, 530, (finish_frame - 300) * 3, 50)
                }
                if (finish_frame >= 360 && finish_frame < 450) {
                    ctx.fillStyle = "yellow"
                    ctx.fillRect(50, 530, 180, 50)
                    ctx.fillStyle = "blue"
                    ctx.fillRect(750 - 180, 530, 180, 50)
                }
                if (finish_frame >= 450) {
                    var y_p = (yellow / (yellow + blue))
                    var b_p = (blue / (yellow + blue))
                    ctx.fillStyle = "yellow"
                    ctx.fillRect(50, 530, y_p * 700, 50)
                    ctx.fillStyle = "blue"
                    ctx.fillRect(750 - b_p * 700, 530, b_p * 700, 50)
                    ctx.font = "40px UDDigiKyokashoN-R";
                    ctx.fillStyle = "black";
                    ctx.textAlign = "left";
                    ctx.fillText(`${Math.round(y_p * 1000) / 10}%`, 50, 570);
                    ctx.textAlign = "right";
                    ctx.fillStyle = "white";
                    ctx.fillText(`${Math.round(b_p * 1000) / 10}%`, 750, 570);
                }

                if (finish_frame - 230 < 40) {
                    ctx.fillStyle = "black";
                    ctx.fillRect(0, 0 + (finish_frame - 230) * 15, canvas.width, canvas.height);
                }
            }
            requestAnimationFrame(update);


            // 中心光（pulses）
            for (let i = pulses.length - 1; i >= 0; i--) {
                const p = pulses[i];
                const u = (now - p.t0) / p.dur; // 0 -> 1
                if (u >= 1) { pulses.splice(i, 1); continue; }

                // 半径が負になるのを防ぐ（ここがバグの原因だった）
                const r = Math.max(0, p.rMax * u);
                const alpha = Math.max(0, CONFIG.baseAlpha * (1 - u));

                // r が極端に小さい場合は createRadialGradient を呼ばずに小さな点を描画する
                if (r <= 0.5) {
                    ctx.globalCompositeOperation = 'lighter';
                    ctx.fillStyle = `rgba(${CONFIG.color.join(',')},${alpha})`;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 1, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.globalCompositeOperation = 'source-over';
                } else {
                    const grad = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, r);
                    const [rC, gC, bC] = CONFIG.color;
                    grad.addColorStop(0.0, `rgba(${rC},${gC},${bC},${alpha})`);
                    grad.addColorStop(1.0, `rgba(${rC},${gC},${bC},0)`);

                    ctx.globalCompositeOperation = 'lighter';
                    ctx.fillStyle = grad;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, r, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.globalCompositeOperation = 'source-over';
                }
            }

            // 爆発パーティクル
            for (let i = particles.length - 1; i >= 0; i--) {
                const part = particles[i];
                const u = (now - part.t0) / part.dur;
                if (u >= 1) { particles.splice(i, 1); continue; }

                // 速度はフレーム単位（CSS ピクセル）
                part.x += part.vx;
                part.y += part.vy;
                const alpha = Math.max(0, (1 - u) * 0.9);

                ctx.fillStyle = `rgba(255,255,255,${alpha})`;
                ctx.beginPath();
                ctx.arc(part.x, part.y, 1.2, 0, Math.PI * 2);
                ctx.fill();
            }

        }
        requestAnimationFrame(update);

        const CONFIG = {
            durationMs: 300,        // 爆発的要素を入れるので少し長め
            maxRadius: 40,          // 爆発の広がり（CSSピクセル）
            baseAlpha: 0.9,         // 明るさ強め
            color: [255, 255, 255], // 白ベース (グレースケール)
            particles: 20           // 爆発パーティクル数
        };
        // devicePixelRatio の取り扱い
        let dpr = Math.max(1, Math.min(window.devicePixelRatio || 1, 3));
        function resize() {
            dpr = Math.max(1, Math.min(window.devicePixelRatio || 1, 3));
            const w = canvas.clientWidth || document.documentElement.clientWidth;
            const h = canvas.clientHeight || document.documentElement.clientHeight;
            canvas.width = Math.round(w * dpr);
            canvas.height = Math.round(h * dpr);
            // 描画を CSS ピクセル基準にするために transform を設定
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        }
        new ResizeObserver(resize).observe(canvas);

        // 発光とパーティクルの履歴
        const pulses = [];
        const particles = [];

        function addPulse(px, py) {
            const now = performance.now();
            pulses.push({ x: px, y: py, t0: now, dur: CONFIG.durationMs, rMax: CONFIG.maxRadius });
            // パーティクルを追加
            for (let i = 0; i < CONFIG.particles; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 0.8 + Math.random() * 2.2; // 速度を少し広めに
                particles.push({ x: px, y: py, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, t0: now, dur: CONFIG.durationMs });
            }
        }
    </script>
</body>

</html>